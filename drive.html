<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MorTeam</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,300,200' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <link href="jbox/jBox.css" rel="stylesheet">
    <link href="jbox/themes/TooltipDark.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css" type="text/css">
    <script type="text/javascript">
        if (localStorage.userToken == undefined) {
            location = "login";
        }
    </script>
    <script src="js/spin.js"></script>
    <script type="text/javascript">
        var loadingDiv = document.createElement("div");
        loadingDiv.className = "loading_circle";
        loadingDiv.id = "loading_circle";
    </script>
</head>

<body>
    <div id="audio-files" style="display: none;">
        <audio id="click-sound">
            <source src="jbox/audio/bling2.wav" type="audio/wav" />
        </audio>
    </div>
    <!-- NAVIGATION BAR -->
    <div class="nav_dropdown">
      <p onclick="location='index'">Home</p>
      <p onclick="location='chat'">Chat</p>
      <p onclick="location='drive'" style="background-color: orange">Drive</p>
      <p onclick="location='cal'">Calendar</p>
      <p onclick="location='networks'">Networks</p>
    </div>
    <div class="navigation_bar">
        <ul id="navbar_list">
          <li class="navbar_item navbar_title" onclick="location='index'">
              MorTeam
          </li>
          <li class="navbar_item searchbox_list_item">
              <input type="text" placeholder="search" class="searchbox"></input>
          </li>
          <li class="navbar_item glyph_link chat_btn menu_btn" onclick="location='chat'">
              <span class="glyphicon glyphicon-comment"></span>
          </li>
          <li class="navbar_item glyph_link drive_btn menu_btn active" onclick="location='drive'">
              <span class="glyphicon glyphicon-hdd"></span>
          </li>
          <li class="navbar_item glyph_link cal_btn menu_btn" onclick="location='cal'">
              <span class="glyphicon glyphicon-calendar"></span>
          </li>
          <li class="navbar_item glyph_link networks_btn menu_btn" onclick="location='networks'">
              <span class="glyphicon glyphicon-globe"></span>
          </li>
          <div class="navbar_item right_links">
            <li class="navbar_item glyph_link menu">
                <span class="glyphicon glyphicon-menu-hamburger"></span>
            </li>
            <li class="navbar_item glyph_link" id="notif_button">
                <span class="glyphicon glyphicon-inbox"></span>
            </li>
            <img class="profile_id" id="small_prof_pic" src="./images/user.jpg"></img>
            <span class="profile_name" id="name_link"></span>
          </div>
        </ul>
    </div>
    <div id="notif_drop" class="hidden">
        <ul>
            <li class="notif_list_item">hey</li>
            <li class="notif_list_item">hi</li>
            <li class="notif_list_item">ho</li>
        </ul>
    </div>
    <div id="prof_drop" class="hidden">
        <ul>
            <li class="notif_list_item" onclick="location='user?user='+localStorage.username;">View Profile and Settings</li>
            <li class="notif_list_item" id="logout_button">Log Out</li>
        </ul>
    </div>
    <div id="darken" class="hidden"></div>
    <!-- END OF NAVIGATION BAR -->

    <!-- BODY -->
    <div class="container-fluid documents_list hidden">
        <div class="grid">
            <input type="file" id="file" class="hidden"></input>
            <div style="z-index:1;" class="doc_frame add_file">
                <span id="add_file_sign" class="glyphicon glyphicon-plus"></span>
            </div>
            <!--<div style="z-index:1;" class="doc_frame image_doc">              // THIS IS A SAMPLE FILE (IMAGE) IN DRIVE
                <div class="hidden confirm_del">
                    <p>Are you sure?</p>
                    <input type="button" value="yes" class="yes"></input>
                    <input type="button" value="no" class="no"></input>
                </div>
                <img src="./images/sample2.jpg" class="doc_preview image_preview" />
                <span class="doc_title">
                    <span class="name">Flower Image</span>
                    <span class="file_size">6.3 MB</span>
                    <span class="glyphicon glyphicon-trash doc_delete"></span>
                </span>
            </div>-->
        </div>
    </div>
    <!-- END OF BODY -->

    <!-- LEFTBAR -->
    <div class="leftbar">
        <ul class="folders_list">
            <li class="drive_name drive_options">
                <div class="btn-group sort_by_dropdown">
                    <button class="button dropdown-toggle" data-toggle="dropdown">Sort By
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li class="sort_by">Date</li>
                        <li class="sort_by">Name</li>
                        <li class="sort_by">Size</li>
                        <li class="sort_by">Type</li>
                    </ul>
                </div>
                <!-- <span class="glyphicon glyphicon-th grid_layout"></span>
                <span class="glyphicon glyphicon-th-list list_layout"></span>  UN-COMMENT WHEN LIST LAYOUT IS READY   -->
            </li>
            <li class="drive_name new_folder">
                <span id="make_drive" class="glyphicon glyphicon-plus"></span>New Folder</li>
            <li class="drive_name">
                <span id="make_drive" data-folderid="" class="glyphicon glyphicon-folder-open def_folder1"></span>All Your Files</li>
            <li class="drive_name">
                <span id="make_drive" class="glyphicon glyphicon-folder-open def_folder2"></span>Team Files</li>
            <li class="drive_name">
                <span id="make_drive" class="glyphicon glyphicon-folder-open def_folder3"></span>Personal Files</li>

        </ul>
    </div>
    <span class="glyphicon glyphicon-chevron-left hide_leftbar"></span>
    <!-- END OF LEFTBAR -->

    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://code.jquery.com/color/jquery.color-2.1.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="js/color-thief.js"></script>
    <script src="jbox/jBox.min.js"></script>
    <script src="js/dropzone.js"></script>
    <script src="js/clamp.min.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/2.2.1/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript" src="js/hex.js"></script>
    <script type="text/javascript">

        var currentFolderID = "";
        var chosenSort = "original-order";

        function extToClass(ext) {
            if ("doc docs docx pages rtf txt".split(" ").indexOf(ext) >= 0) {
                return "word_doc";
            } else if ("key ppt pptx".split(" ").indeOf("ext") >= 0) {
                return "keynote_doc";
            } else if ("xls xlsx numbers _xls xmlsb xlsm xltx xlt".split(" ").indexOf(ext) >= 0) {
                return "excel_doc";
            } else if (ext == "pdf") {
                return "pdf_doc";
            } else if ("mp3 wav m4a avi wma ogg m4p ra ram rm mid mp4 webm flv mkv ogv mov avi wmv m4p mpg".split(" ").indexOf(ext) >= 0) {
                return "audio_doc";
            } else if ("png jpg jpeg jif jfif gif raw tif bmp rif tiff webp".split(" ").indexOf(ext) >= 0) {
                return "image_doc";
            } else {
                return "default_doc";
            }
        }
        function loadUsersOnFolderModal(modal) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getteammates", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var users = JSON.parse(xhr.responseText);
                        people = users;
                        var content = "";
                        for (var i = 0; i < people.length; i++) {
                            var person = people[i].first + " " + people[i].last;
                            var nameP = "<p class='selected_folder_member' data-username='" + people[i].user + "'>" + person + "</p>"
                            content += nameP;
                        }
                        var modal_content = '<input type="text" class="folder_name" placeholder="Folder Name"></input><br/>Please select who can view the folder:<br/><input type="text" placeholder="Search Names..." id="select_folder_members"></input><br/><div id="selected_folder_members">' +
                        content + '</div><br/><input type="button" class="button make_folder_button" value="Make Folder"></input>'
                        modal.setContent(modal_content);
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "teamCode": localStorage.teamCode
            }));
        }
        function loadPeople() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/f/getteammates", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText != "fail") {
                        var users = JSON.parse(xhr.responseText);
                        people = users;
                    }
                }
            };
            xhr.send(JSON.stringify({
                "user": localStorage.username,
                "teamCode": localStorage.teamCode
            }));
        }
        function scopesToUsersAndCreateFolder(){
            var nameOfFolder = $(".folder_name").val().replace(/'/g, "''");
            var folder_name = document.createTextNode($(".folder_name").val());
            var usersBadges = $("p.clicked:not(.scope_badge)");
            var scopeBadges = $(".scope_badge.clicked");
            var users = [];
            var scopes = [""];
            for (var i = 0; i < usersBadges.length; i++) {
                users.push($(usersBadges[i]).attr("data-username"));
            }
            for (var i = 0; i < scopeBadges.length; i++) {
                scopes.push($(scopeBadges[i]).html());
            }
            var allUsers = [];
            var done = 0;
            for (var i = 0; i < scopes.length; i++){
                request("POST", "/f/getusersinscope", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode, "scopeName":scopes[i]}), function(responseText){
                    var usersFromScope = JSON.parse(responseText);
                    for (var j = 0; j < usersFromScope.length; j++){
                        if (usersFromScope[j].user != localStorage.username){
                            allUsers.push(usersFromScope[j].user);
                        }
                    }
                    if (done++ == scopes.length - 1){
                        users = users.concat(allUsers);
                        var uniqueUsers = [];
                        $.each(users, function(i, el){
                            if($.inArray(el, uniqueUsers) === -1) uniqueUsers.push(el);
                        });
                        users = uniqueUsers;
                        request("POST", "/f/newfolder", JSON.stringify({"user":localStorage.username, "scopes":scopes,"teamCode":localStorage.teamCode, "people":users, "folderName":nameOfFolder}), function(responseText){
                            var li = $(document.createElement("li"));
                            var span = $(document.createElement("span"));
                            var span2 = $(document.createElement("span"));
                            li.append(span);
                            li.attr("class", "drive_name");
                            span.attr("id", "make_drive");
                            span.attr("data-folderid", responseText);
                            span.attr("class", "glyphicon glyphicon-folder-open");
                            li.append(folder_name);
                            $('.folders_list').append(li);
                            span2.attr("class", "glyphicon glyphicon-cog");
                            span2.addClass("list_right")
                            span2.addClass("options_li")
                            $(li).append(span2);
                            folder_modal.close();
                        });
                    }
                });
            }
        }
        function getScopesAndLoadUsersOnFolderModal(people){
            var allScopes = [];
            request("POST", "/f/getpublicscopesforteam", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode}), function(responseText){
                var scopes = JSON.parse(responseText);
                for (var i = 0; i < scopes.length; i++){
                    allScopes.push(scopes[i].scopeName);
                }
                request("POST", "/f/getyourscopes", JSON.stringify({"user":localStorage.username, "teamCode":localStorage.teamCode}), function(responseText2){
                    var scopes = JSON.parse(responseText2);
                    for (var i = 0; i < scopes.length; i++){
                        allScopes.push(scopes[i].scopeName);
                    }
                    var allUniqueScopes = [];
                    $.each(allScopes, function(i, el){
                        if($.inArray(el, allUniqueScopes) === -1) allUniqueScopes.push(el);
                    });
                    //return allUniqueScopes;
                    var content = "";
                    for (var i = 0; i < allUniqueScopes.length; i++) {
                        var scopeP = "<p class='selected_folder_member scope_badge'>" + allUniqueScopes[i] + "</p>"
                        content += scopeP;
                    }
                    for (var i = 0; i < people.length; i++) {
                        var person = people[i].first + " " + people[i].last;
                        var nameP = "<p class='selected_folder_member data-username='" + people[i].user + "'>" + person + "</p>"
                        content += nameP;
                    }
                    var initialContent =
                        "<input type='text' placeholder='Folder Name' class='folder_name'><br/>Please select who can view the folder:<br/><input type='text' placeholder='Search Names...' id='select_folder_members'></input><br/><div id='selected_folder_members'>" +
                        content + "</div><br/><input type='button' value='Make Folder' class='button make_folder_button'></input>"
                    folder_modal.setContent(initialContent);
                    var group_names = $('.selected_folder_member p');
                    $('#select_folder_members').keyup(function() {
                        var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                        group_names.show().filter(function() {
                            var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                            return !~text.indexOf(val);
                        }).hide();
                    });
                });
            });
        }
        jQuery.fn.flash = function(color, duration) {
            var current = this.css('backgroundColor');
            this.animate({
                    backgroundColor: color
                }, duration / 2)
                .animate({
                    backgroundColor: current
                }, duration / 2);
        }
        function showDropHere() {
            $("#add_file_sign").removeClass("glyphicon-plus")
            $("#add_file_sign").html("Drop Here");
            $(".add_file").css("background-color", "#f5f5f5");
            $("#add_file_sign").css("font-size", "40px");
        }

        function hideDropHere() {
            $("#add_file_sign").addClass("glyphicon-plus")
            $("#add_file_sign").html("");
            $(".add_file").css("background-color", "#e9e9e9")
            $("#add_file_sign").css("font-size", "60px");
        }
        function loadFolders() {
            //$(".def_folder1").attr("data-folderid", localStorage.username);
            $(".def_folder2").attr("data-folderid", localStorage.teamCode);
            $(".def_folder3").attr("data-folderid", localStorage.username);
            request("POST", "/f/getfolders", JSON.stringify({"user":localStorage.username}), function(responseText){
                var folders = JSON.parse(responseText);
                for (var i = 0; i < folders.length; i++){
                    var li = document.createElement("li");
                    var span = $(document.createElement("span"));
                    var span2 = $(document.createElement("span"));
                    $(li).append(span);
                    $(li).attr("class", "drive_name");
                    $(li).attr("title", folders[i].folderName.replace(/</g, "&lt"));
                    span.attr("id", "make_drive");
                    span.attr("data-folderid", folders[i].folderCode);
                    span.attr("class", "glyphicon glyphicon-folder-open");
                    var folder_name_display = '<span class="folder_name_display">' + folders[i].folderName.replace(/</g, "&lt") +'</span>'
                    li.innerHTML += folder_name_display
                    $('.folders_list').append(li);
                    span2.attr("class", "glyphicon glyphicon-cog");
                    span2.addClass("list_right")
                    span2.addClass("options_li")
                    $(li).append(span2);

                }
            });
        }

        $(document).ready(function() {

            loadFolders();
            var didClickNew = false;
            var didClickNewFile = false;

            document.body.appendChild(loadingDiv);

            folder_modal = new jBox('Modal', {
              attach: $('.new_folder'),
              title: 'New Folder',
              width: 350,
              height: 340,
              onOpen: function() {
                  didClickNew = false;
                  //loadUsersOnFolderModal(folder_modal);
                  getScopesAndLoadUsersOnFolderModal(people);
                  $(document).on("keyup", '#select_folder_members', function() {
                    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
                    $('#selected_folder_members p').show().filter(function() {
                        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
                        console.log(!~text.indexOf(val));
                        return !~text.indexOf(val);
                    }).hide();
                  });
                  $(document).on("click", '.make_folder_button', function() {
                    // CODE TO CREATE FOLDER HERE
                    if (!didClickNew){
                            didClickNew = true;
                            console.log('YES')
                            /*var nameOfFolder = $(".folder_name").val().replace(/'/g, "''");
                            var folder_name = document.createTextNode($(".folder_name").val());
                            var usersBadges = $("p.clicked");
                            var users = [];
                            for (var i = 0; i < usersBadges.length; i++) {
                                users.push($(usersBadges[i]).attr("data-username"));
                            }
                            request("POST", "/f/newfolder", JSON.stringify({"user":localStorage.username, "people":users, "folderName":nameOfFolder}), function(responseText){
                                var li = $(document.createElement("li"));
                                var span = $(document.createElement("span"));
                                var span2 = $(document.createElement("span"));
                                li.append(span);
                                li.attr("class", "drive_name");
                                span.attr("id", "make_drive");
                                span.attr("data-folderid", responseText);
                                span.attr("class", "glyphicon glyphicon-folder-open");
                                li.append(folder_name);
                                $('.folders_list').append(li);
                                span2.attr("class", "glyphicon glyphicon-cog");
                                span2.addClass("list_right")
                                span2.addClass("options_li")
                                $(li).append(span2);
                                folder_modal.close();
                            });*/
                            scopesToUsersAndCreateFolder();
                        }
                  });
              }
            });
            //loadUsersOnFolderModal(folder_modal);
            //getScopesAndLoadUsersOnFolderModal(people);
            loadPeople();
            $(document).on("click", ".selected_folder_member", function() {
                // do stuff with $(this) when a name has been clicked in group_modal
                if ($(this).hasClass("clicked")) {
                    $(this).removeClass("clicked");
                } else {
                    $(this).addClass('clicked');
                }
            });


            spinnerOpts = {
                lines: 13 // The number of lines to draw
                    ,
                length: 0 // The length of each line
                    ,
                width: 20 // The line thickness
                    ,
                radius: 42 // The radius of the inner circle
                    ,
                scale: .5 // Scales overall size of the spinner
                    ,
                corners: 1 // Corner roundness (0..1)
                    ,
                color: 'orange' // #rgb or #rrggbb or array of colors
                    ,
                opacity: 0.25 // Opacity of the lines
                    ,
                rotate: 0 // The rotation offset
                    ,
                direction: 1 // 1: clockwise, -1: counterclockwise
                    ,
                speed: 1 // Rounds per second
                    ,
                trail: 60 // Afterglow percentage
                    ,
                fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
                    ,
                zIndex: 2e9 // The z-index (defaults to 2000000000)
                    ,
                className: 'spinner' // The CSS class to assign to the spinner
                    ,
                top: '50%' // Top position relative to parent
                    ,
                left: '50%' // Left position relative to parent
                    ,
                shadow: false // Whether to render a shadow
                    ,
                hwaccel: false // Whether to use hardware acceleration
                    ,
                position: 'absolute' // Element positioning
            }

            var options_modal = new jBox('Modal', {
                width: 350,
                height: 'auto',
                title: 'Options',
                onOpen: function() {

                }
            });
            $(document).on("click", ".add_group_member", function(){
              $(this).replaceWith("<span class='member_search_span'><input type='text' placeholder='Search Users' class='member_search'><div class='search_drop member_search_drop'><ul><li class='member_option'>Bob Jones</li><li class='member_option'>Bob Jones</li></ul></div></input><span class='glyphicon glyphicon-remove cancel'></span></span>");
              $(".member_search").focus();
            })
            $(document).on("keyup", ".member_search", function(){
              if($(this).val() != ""){
                $(".member_search_drop").show();
              }else{
                $(".member_search_drop").hide();
              }
            });
            $(document).on("click", ".cancel", function(){
              $(".member_search_span").replaceWith('<li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li>');
            });
            $(document).on("click", ".member_option", function(){
              $(".member_search_drop").hide();
              $(".member_search_span").replaceWith('<li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li>');
              $(".add_group_member").after('<li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">Bob Jones</span><span class="member_remove glyphicon glyphicon-remove"></span></li>') //POSSIBLE ERROR IN THE FUTURE DUE TO .add_group_member NOT EXISTING AT THE TIME OF APPENDING
            });
            $(document).on("click", ".member_remove", function(){
              if (window.confirm("Are you sure?")) {
                $(this).parent().remove();
              }
            })
            $(document).on("click", ".options_li", function(){
              var currentName = $(this).prev().html();
              options_modal.open();
              options_modal.setContent('<input type="text" class="change_name" value="'+ currentName +'"></input><br/><div class="group_members"><ul class="current_group_members"><li class=" add_group_member"><span class="glyphicon glyphicon-plus"></span><span class="group_member_name">Add Member(s)</span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li><li><img id="small_prof_pic" src="./images/user.jpg"></img><span class="group_member_name">John Smith</span><span class="member_remove glyphicon glyphicon-remove"></span></li></ul></div><input type="button" class="button leave_group" value="Leave Group"></input><input type="button" class="button delete_group" value="Delete Folder"></input><input type="button" class="button save_options" value="Save"></input>')
            });

            var file_modal = new jBox('Modal', {
                width: 300,
                height: 230,
                attach: $('.add_file'),
                title: 'Upload a File',
                onOpen: function() {
                    didClickNewFile = false;
                    $("#chosen_file").html("No File Selected");
                    $("#file").val("");
                    $(".file_name")[0].value = "";

                    $(".upload_button").unbind().click(function() {
                        if (!didClickNewFile && typeof(uploads) != "undefined"){
                            didClickNewFile = true;
                            console.log(uploads);

                            var fileName = $(".file_name").val().replace(/'/g, "''").replace(/</g, "&lt");
                            var teamCode = localStorage.teamCode;
                            var user = localStorage.username;
                            var rawFileName = "";

                            if (uploads.length == undefined) {
                                if (uploads.size > 50000000) {
                                    alert("file is too big");
                                } else {
                                    rawFileName = uploads.name;
                                    var xhr = new XMLHttpRequest();
                                    xhr.open("POST", "/f/uploadtodrive?user=" + escape(user) + "&teamcode=" + escape(teamCode) + "&folder=" + escape(currentFolderID) + "&filename=" + escape(fileName) + "&rawname=" + escape(
                                        rawFileName), true);
                                    xhr.onreadystatechange = function() {
                                        if (xhr.readyState == 4 && xhr.status == 200) {
                                            if (xhr.responseText != "Too large") {
                                                var data = JSON.parse(xhr.responseText);
                                                var fileSize = data.fileSize;
                                                var fileType = data.fileType;
                                                var fileCode = data.fileCode;
                                                console.log(data);

                                                var imgSrc = "";
                                                var imgClass = "";
                                                var isImg;
                                                if (extToClass(fileType) == "image_doc") {
                                                    imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + fileCode;
                                                    imgClass = " image_preview";
                                                    isImg = true;
                                                } else {
                                                    imgSrc = "./images/" + extToClass(fileType).split('_')[0] + ".png";
                                                    isImg = false;
                                                }
                                                var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(fileType) + '" data-fileid="' + fileCode + '" title="' + fileName.replace(/''/g, "'") +
                                                    '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' +
                                                    imgSrc + '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + fileName.replace(/''/g, "'") + '</span><span class="file_size">' + fileSize +
                                                    '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                                $grid.append($newFile).isotope("insert", $newFile);
                                                $newFile.jBox('Tooltip', {
                                                    delayOpen: 700,
                                                    delayClose: 300,
                                                    theme: "TooltipDark",
                                                    position: {
                                                        y: 'bottom'
                                                    }
                                                });
                                                if(isImg){
                                                  thisImg = document.createElement("img");
                                                  thisImg.src = imgSrc
                                                  thisImg.onload = function(){
                                                    var colorThief = new ColorThief();
                                                    var color = colorThief.getColor(this);
                                                    setTimeout(function(){
                                                      $newFile.css("backgroundColor", "rgb(" + color + ")");
                                                      $newFile.find(".image_preview").show();
                                                      var r = color[0];
                                                      var g = color[1];
                                                      var b = color[2];
                                                      var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                                      if (luma > 170) {
                                                          $newFile.find(".doc_title").children().css("color", "black");
                                                      }
                                                    }, 400);
                                                  };
                                                }
                                                var title = $newFile.find(".doc_title>span")[0];
                                                $clamp(title, {
                                                    clamp: 2
                                                })

                                                file_modal.close();
                                            }

                                        }
                                    };
                                    xhr.send(uploads);

                                }
                            } else {
                                if (uploads[0].size > 50000000) {
                                    alert("file is too big");
                                } else {
                                    rawFileName = uploads[0].name;

                                    var xhr = new XMLHttpRequest();
                                    xhr.open("POST", "/f/uploadtodrive?user=" + escape(user) + "&teamcode=" + escape(teamCode) + "&folder=" + escape(currentFolderID) + "&filename=" + escape(fileName) + "&rawname=" + escape(
                                        rawFileName), true);
                                    xhr.onreadystatechange = function() {
                                        if (xhr.readyState == 4 && xhr.status == 200) {
                                            if (xhr.responseText != "fail") {
                                                var data = JSON.parse(xhr.responseText);
                                                var fileSize = data.fileSize;
                                                var fileType = data.fileType;
                                                var fileCode = data.fileCode;
                                                console.log(data);

                                                var imgSrc = "";
                                                var imgClass = "";
                                                var isImg;
                                                if (extToClass(fileType) == "image_doc") {
                                                    imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + fileCode;
                                                    imgClass = " image_preview";
                                                    isImg = true;
                                                } else {
                                                    imgSrc = "./images/" + extToClass(fileType).split('_')[0] + ".png";
                                                    isImg = false;
                                                }
                                                var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(fileType) + '" data-fileid="' + fileCode + '" title="' + fileName.replace(/''/g, "'") +
                                                    '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' +
                                                    imgSrc + '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + fileName.replace(/''/g, "'") + '</span><span class="file_size">' + fileSize +
                                                    '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                                $grid.append($newFile).isotope("insert", $newFile);
                                                $newFile.jBox('Tooltip', {
                                                    delayOpen: 700,
                                                    delayClose: 300,
                                                    theme: "TooltipDark",
                                                    position: {
                                                        y: 'bottom'
                                                    }
                                                });
                                                if(isImg){
                                                  thisImg = document.createElement("img");
                                                  thisImg.src = imgSrc
                                                  thisImg.onload = function(){
                                                    var colorThief = new ColorThief();
                                                    var color = colorThief.getColor(this);
                                                    setTimeout(function(){
                                                      $newFile.css("backgroundColor", "rgb(" + color + ")");
                                                      $newFile.find(".image_preview").show();
                                                      var r = color[0];
                                                      var g = color[1];
                                                      var b = color[2];
                                                      var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                                      if (luma > 170) {
                                                          $newFile.find(".doc_title").children().css("color", "black");
                                                      }
                                                    }, 400);
                                                  };
                                                }
                                                var title = $newFile.find(".doc_title>span")[0];
                                                $clamp(title, {
                                                    clamp: 2
                                                })

                                                file_modal.close();
                                            }

                                        }
                                    };
                                    xhr.send(uploads[0]);
                                }
                            }
                        }
                        else {
                            alert("File not chosen/You cannot upload a file twice");
                        }
                    });
                }
            });
            var file_modal_content =
                "<input type='button' class='button file_choose' value='Choose File'></input><p id='chosen_file'>No File Selected</p><input type='text' class='file_name' placeholder='File Name'></input><input type='button' class='button upload_button' value='Upload'></input>"
            file_modal.setContent(file_modal_content);
            $(".file_choose").click(function() {
                $("#file").trigger("click");
            });

            document.getElementById("file").onchange = function() {
                uploads = this.files;
                if (this.files.length == 1) {
                    document.getElementById("chosen_file").innerHTML = this.files[0].name;
                    setTimeout(function() {
                        $("#chosen_file").flash("#0099ff", 1000);
                    }, 300);
                } else {
                    document.getElementById("chosen_file").innerHTML = "Multiple Selected";
                    setTimeout(function() {
                        $("#chosen_file").flash("#0099ff", 1000);
                    }, 300);
                }
            };
            var myDropzone = new Dropzone(".add_file", {
                url: "#",
                createImageThumbnails: false,
                clickable: false,
                previewTemplate: "<div id='preview-template' style='display: none;''>",
                uploadMultiple: false
            });
            myDropzone.on("addedfile", function(file) {
                uploads = file;
                file_modal.open();
                document.getElementById("chosen_file").innerHTML = file.name;
                setTimeout(function() {
                    $("#chosen_file").flash("#0099ff", 1000);
                }, 300);
            });


            $("html").on("dragenter", function(event) {
                event.preventDefault();
                event.stopPropagation();
                showDropHere();
            });
            $("html").on("drop", function(event) {
                event.preventDefault();
                event.stopPropagation();
                hideDropHere();
            });
            $(".add_file").on("drop", function(event) {
                event.preventDefault();
                event.stopPropagation();
                hideDropHere();
            });
            $("html").on("mouseenter", function(event) {
                event.stopPropagation();
                event.preventDefault();
                hideDropHere();
            })
            $("html").on('dragover', function() {
                event.preventDefault();
            });
            $("html").mouseleave(function() {
                hideDropHere();
            });



            function hideLeftbar(time, button) {
                $(".leftbar").velocity({
                    left: "-260px"
                }, time);
                $(".documents_list").velocity({
                    left: "40px"
                }, time);
                $(button).removeClass("glyphicon-chevron-left").addClass("glyphicon-chevron-right");
                $(button).velocity({
                    left: "10px"
                }, time);
                setTimeout(function() {
                    $(".documents_list").css("width", "calc(100vw - 60px)")
                    $grid.isotope();
                }, time)
            }

            function showLeftbar(time, button) {
                $(".leftbar").velocity({
                    left: "0px"
                }, time);
                $(".documents_list").velocity({
                    left: "300px"
                }, time);
                $(button).removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-left");
                $(button).velocity({
                    left: "220px"
                }, time);
                setTimeout(function() {
                    $(".documents_list").css("width", "calc(100vw - 320px)")
                    $grid.isotope();
                }, time);
            }
            $(".hide_leftbar").click(function() {
                if ($(this).hasClass("glyphicon-chevron-left")) {
                    hideLeftbar(300, this);
                } else {
                    showLeftbar(300, this);
                }
            });
            if ($(window).width() < 825) {
                hideLeftbar(0, ".hide_leftbar");
            }

        });

        function debounce(fn, threshold) {
            var timeout;
            return function debounced() {
                if (timeout) {
                    clearTimeout(timeout);
                }

                function delayed() {
                    fn();
                    timeout = null;
                }
                timeout = setTimeout(delayed, threshold || 100);
            }
        }
        $(window).load(function() {
            $(".documents_list").fadeIn(400).removeClass("hidden");

            var qsRegex;

            $grid = $('.grid').isotope({
                itemSelector: '.doc_frame',
                layoutMode: 'fitRows',
                transformEnabled: false,
                isAnimated: false,
                filter: function() {
                    return qsRegex ? $(this).text().match(qsRegex) : true;
                },
                getSortData: {
                    name: function(itemElem) {
                      var name =  $(itemElem).find(".name").html();
                      if(typeof(name) == "undefined"){
                        return name;
                      }
                      return name.toLowerCase();
                    },
                    size: function(itemElem) {
                        var size = $(itemElem).find('.file_size').text();
                        if (size.indexOf("GB") > -1){
                          size = size.substring(0, size.indexOf("GB"));
                          return parseFloat(size.replace(/[\(\)]/g, '')) * 1000000000;
                        } else if (size.indexOf("MB") > -1) {
                            size = size.substring(0, size.indexOf("MB"));
                            return parseFloat(size.replace(/[\(\)]/g, '')) * 1000000;
                        } else if (size.indexOf("KB") > -1){
                            size = size.substring(0, size.indexOf("KB"));
                            return parseFloat(size.replace(/[\(\)]/g, '')) * 1000;
                        }else{
                            return parseFloat(size.replace(/[\(\)]/g, ''));
                        }
                    },
                    type: function(itemElem) {
                        if ($(itemElem).hasClass("add_file")) {
                            return "a"
                        } else if ($(itemElem).hasClass("word_doc")) {
                            return "a";
                        } else if ($(itemElem).hasClass("pdf_doc")) {
                            return "b";
                        } else if ($(itemElem).hasClass("keynote_doc")) {
                            return "c";
                        } else if ($(itemElem).hasClass("excel_doc")) {
                            return "d";
                        } else if ($(itemElem).hasClass("audio_doc")) {
                            return "e";
                        } else if ($(itemElem).hasClass("default_doc")) {
                            return "f";
                        } else if ($(itemElem).hasClass("image_doc")) {
                            return "g";
                        } else {
                            return "z";
                        }
                    }
                }

            });


            // $('.doc_frame:not(.add_file)').jBox('Tooltip', {
            //     delayOpen: 700,
            //     delayClose: 300,
            //     theme: "TooltipDark",
            //     position: {
            //         y: 'bottom'
            //     }
            // });

            $(document).on("click", ".doc_frame:not(.add_file)", function(e) {
                var a = $(e.target);
                var b = $(this).find(".doc_delete");
                var c = $(this).find("input");
                if (a[0] != b[0] && a[0] != c[0] && a[0] != c[1]) {
                    location = "/f/getfile?user=" + localStorage.username + "&filecode=" + $(this).attr("data-fileid");
                    //alert($(this).find(".doc_title>span").html()); // title of document
                }
            });
            $(document).on("click", ".doc_delete", function() {
                var frame = $(this).parent().parent();
                frame.find(".confirm_del").css("background-color", frame.css("background-color"));
                frame.find(".confirm_del").fadeIn(150).removeClass("hidden");
                $(frame).click(function(e) {
                    var a = $(e.target);
                    var b = $(this).find(".doc_delete");
                    var c = $(this).find("input");
                    if (a[0] != b[0] && a[0] != c[0] && a[0] != c[1]) {
                        frame.find(".confirm_del").fadeOut(150);
                    }
                });
                $(frame.find(".yes")).click(function() {
                    var fileCode = frame.attr("data-fileid");
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/f/deletefile", true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            if (xhr.responseText == "success") {
                                $grid.isotope('remove', frame).isotope();
                            }
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user": localStorage.username,
                        "fileCode": fileCode,
                        "token":localStorage.userToken
                    }));
                });
                $(frame.find(".no")).click(function() {
                    frame.find(".confirm_del").fadeOut(150);
                });
            });

            $(document).on("mouseenter", ".doc_frame", function() {
                //originalColor = rgb2hex($(this).css("backgroundColor"));
                $(this).css({
                    backgroundColor: "#" + rgb2hex($(this).css('backgroundColor')).darkenHexColorBy(25)
                })
            });
            $(document).on("mouseleave", ".doc_frame", function() {
                $(this).css({
                    backgroundColor: "#" + rgb2hex($(this).css('backgroundColor')).lightenHexColorBy(25)
                })
            });


            $(document).on("click", ".drive_name:not(.new_folder, .drive_options)", function(e) {

              var a = $(e.target);
              var b = $(this).find(".list_right");
              if (a[0] != b[0] && a[0] != b[1]){
                if( !$(this).hasClass('selected') ){
                  if( $(this).find("#make_drive").attr("data-folderid") == "" ){
                    $(".add_file").hide();
                  }else{
                    $(".add_file").show();
                  }
                  $(".drive_name:not(.new_folder, .drive_options)").removeClass("selected");
                  $(this).addClass("selected");
                  currentFolderID = $(this).children().first().attr("data-folderid");
                  //GET FILES WITH FOLDER ID
                  $grid.isotope("remove", $(".doc_frame:not(.add_file)")).isotope()

                  fileImg = [];
                  tempFile = [];
                  imgCounter = 0;

                  var url = "/f/showfiles";
                  if (currentFolderID == ""){
                      url = "/f/showallfiles";
                  }
                  spinner = new Spinner(spinnerOpts).spin(loadingDiv);
                  var xhr = new XMLHttpRequest();
                  xhr.open("POST", url, true);
                  xhr.onreadystatechange = function() {
                      if (xhr.readyState == 4 && xhr.status == 200) {
                          if (xhr.responseText != "fail") {
                              var files = JSON.parse(xhr.responseText)
                              if (files.length == 0){
                                //no files so it has loaded
                                spinner.stop();
                              }
                              for (var i = 0; i < files.length; i++) {
                                  if (i == files.length - 1){
                                    //files loaded
                                    spinner.stop();
                                  }
                                  var imgSrc = "";
                                  var imgClass = "";
                                  var isImg = false;
                                  if (extToClass(files[i].fileType) == "image_doc") {
                                      imgSrc = "/f/getfile?user=" + localStorage.username + "&filecode=" + files[i].fileCode;
                                      imgClass = " image_preview"
                                      isImg = true
                                  } else {
                                      imgSrc = "./images/" + extToClass(files[i].fileType).split('_')[0] + ".png";
                                  }
                                  if (files[i].user == localStorage.username){//Add if leader or admin
                                      var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(files[i].fileType) + '" data-fileid="' + files[i].fileCode + '" title="' + files[i].fileName +
                                          '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' + imgSrc +
                                          '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + files[i].fileName + '</span><span class="file_size">' + files[i].fileSize +
                                          '</span><span class="glyphicon glyphicon-trash doc_delete"></span></span></div>');
                                  }
                                  else {
                                      var $newFile = $('<div style="z-index:1;" class="doc_frame ' + extToClass(files[i].fileType) + '" data-fileid="' + files[i].fileCode + '" title="' + files[i].fileName +
                                          '"><div class="hidden confirm_del"><p>Are you sure?</p><input type="button" value="yes" class="yes"></input><input type="button" value="no" class="no"></input></div><img src="' + imgSrc +
                                          '" class="doc_preview'+imgClass+'" /><span class="doc_title"><span class="name">' + files[i].fileName + '</span><span class="file_size">' + files[i].fileSize +
                                          '</span></span></div>');
                                  }

                                  $grid.append($newFile).isotope("appended", $newFile);
                                  $newFile.jBox('Tooltip', {
                                      delayOpen: 700,
                                      delayClose: 300,
                                      theme: "TooltipDark",
                                      position: {
                                          y: 'bottom'
                                      }
                                  });
                                  if(isImg){
                                    fileImg[imgCounter] = document.createElement("img");
                                    fileImg[imgCounter].src = imgSrc;
                                    $(fileImg[imgCounter]).attr("data-order", imgCounter)
                                    tempFile[imgCounter] = $newFile;

                                    fileImg[imgCounter].onload = function(){
                                      var colorThief = new ColorThief();
                                      var color = colorThief.getColor(this);
                                      tempFile[$(this).attr("data-order")].css("background-color", "rgb(" + color + ")");
                                      tempFile[$(this).attr("data-order")].find(".image_preview").show();
                                      var r = color[0];
                                      var g = color[1];
                                      var b = color[2];
                                      var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                                      if (luma > 170) {
                                          tempFile[$(this).attr("data-order")].find(".doc_title").css("color", "black");
                                      }
                                    };

                                    imgCounter++;
                                  }
                              }
                              var titles = $(".doc_title>span");
                              for (i = 0; i < titles.length; i++) {
                                  $clamp(titles[i], {
                                      clamp: 2
                                  })
                              }
                          }
                      }
                  };
                  xhr.send(JSON.stringify({
                      "user": localStorage.username,
                      "folder": currentFolderID,
                      "teamCode": localStorage.teamCode
                  }));
                }
              }
            });

            $(document).on("click", ".delete_li", function(){
              if (window.confirm("Are you sure?")) {
                $(this).parent().remove();
              }
            });
            $($(".drive_name")[2]).trigger("click");

            var $quicksearch = $('.searchbox').keyup(debounce(function() {
                qsRegex = new RegExp($quicksearch.val(), 'gi');
                $grid.isotope();
                if(currentFolderID == ""){
                   $(".add_file").hide();
                   $grid.isotope();
                }
            }, 200));

            var ascending;

            $(".sort_by").click(function() {

               if( !$(this).hasClass("selected") ){
                  if(ascending == undefined){
                    ascending = true;
                  }
                  var chosenSort = "";
                  $(".sort_by").removeClass("selected");
                  $(this).addClass("selected");
                  chosenSort = $(this).html().toLowerCase();
                  if (chosenSort === "date") {
                      chosenSort = "original-order";
                  }
                  console.log(ascending);
                  $grid.isotope({
                      sortBy: chosenSort,
                      sortAscending: ascending
                  })
                  ascending = !ascending;
                  console.log(ascending);
                }else{
                  if(ascending == undefined){
                    ascending = true;
                  }
                  var chosenSort = "";
                  $(".sort_by").removeClass("selected");
                  $(this).addClass("selected");
                  chosenSort = $(this).html().toLowerCase();
                  if (chosenSort === "date") {
                      chosenSort = "original-order";
                  }
                  console.log(ascending);
                  $grid.isotope({
                      sortBy: chosenSort,
                      sortAscending: ascending
                  })
                  ascending = !ascending;
                }
            });


        });
        window.onunload = function() {};
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-66914799-1', 'auto');
      ga('send', 'pageview');

    </script>

</body>

</html>
